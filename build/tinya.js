var S=(e,n)=>Object.fromEntries(Object.entries(e).map(([r,t])=>[r,n(t,r)])),ee=e=>typeof e,F=(e,n=ee)=>r=>n(r)===e,x=F("number"),A=F("undefined"),g=F("string"),R=e=>e===null,U=e=>e.length===0,h=(e,...n)=>n.some(r=>r(e)),N=Array.isArray,z=F("object"),B=e=>h(e,R,A,x)||g(e)&&!(I(e)||T(e)||C(e)),_=e=>h(e,g,x,A,R)?!1:N(e)&&g(e[0])?J(e)?_(P(e)):!0:N(e[0])&&!U(e[0])&&g(e[0][0]),j=e=>n=>g(n)&&n.startsWith(e),I=j("."),T=j("="),C=j(">"),J=e=>N(e)&&T(e[0]),L=e=>J(e)?e[0]:void 0,P=e=>J(e)?e.slice(1):e,w={},q=e=>(w[e]=(w[e]||0)+1,`${e}${w[e]}`);var ge=(e,n)=>{let r=[],t=[],o=u=>{let a=L(u),s=P(u);for(var c=1;c<s.length;c++){let p=s[c];_(p)?o(p):h(p,T,C,I)?r.push(p):B(p)&&r.push([p])}r.push([t.length,s.length-1]);let[l,m]=N(s[0])&&!U(s[0])?[s[0][0],s[0].slice(1)]:[s[0],[]],i=g(l)&&n[l]||(()=>{throw new Error("undefined node type "+l)});t.push([i,m]),a!==void 0&&r.push(a)};return o(e),[r,t]},ne="|   ",ye=(e,n)=>{let[r,t]=e,o=m=>{for(var i of Object.keys(n))if(n[i]===m)return i;return m.name||"unknown"},u=t.map(([m,i],p)=>`call ${o(m)}(${i.join(", ")}) [index ${p}]`),a=[];var s=r.length-1;let c=(m,i)=>{a.push(`${ne.repeat(m)}${i}`)},l=m=>{if(s<0)return;let i=r[s--];if(N(i))if(i.length===1)c(m,`push constant ${String(i[0])}`);else{let[f,b]=i;c(m,`${u[f]} with ${b}`);for(var p=0;p<b;p++)l(m+1)}else g(i)&&(I(i)?c(m,`push register ${i.slice(1)}`):C(i)?c(m,`push input channel ${i.slice(1)}`):T(i)&&(c(m,`store register ${i.slice(1)}`),l(m)))};return l(0),a.join(`
`)+`

`};var k=(e,n)=>{var r;return h(e,g,x,A,R)?e:N(e)?g(e[0])&&e[0]in n?h(r=n[e[0]](...e.slice(1)),N,z)?k(r,n):r:e.map(t=>k(t,n)):S(e,t=>k(t,n))};var re=(e,n=1,r=0,t=0,o=1,u=1/n,a=1)=>{let s=["add"],c=e[a];for(var l=1;l<=n;l++){let m=t+r*(2*(l-1)/(n-1||1)-.5),i=Math.pow(2,m/12);s[l]=e.with(a,x(c)?c*i:["gain",c,i]),l>1&&o!==1&&(s[l]=["gain",o,s[l]])}return u!==1?["gain",u,s]:s},te=(e,n,r=.9,t=!1)=>{let o=q("=combfilter_feed_"),u=t?[]:[o],a=t?[o]:[];return[...u,"add",[...a,"add",e],["gain",r,[["delay",n],"."+o.slice(1)]]]},$e={unison:re,combfilter:te};var oe=(e,n=1,r,t,o)=>o>0?n<0?t+(r-t)*((o-e)/o)**-n:r+(t-r)*(e/o)**n:t,W=(e,n)=>{let r=[],t=[],o=[],u=[];for(var a=0,s=0;s<e.length;s+=3){let c=(e[s]??0)*n;r.push(c),t.push(a),o.push(e[s+1]??1),u.push(e[s+2]??0),a+=c}return[r,t,o,u]},E=(e,n)=>{let[r,t,o,u]=W(n,e);var a=0;return s=>{if(s>=t.at(-1)+r.at(-1))return 0;for(;s<t[a];)a--;for(;s>t[a]+r[a];)a++;return oe(s-t[a],o[a],u[a-1]??0,u[a],r[a])}},se=(e=0,n=0,r=0,t=1,o=.1,u=0,a=5)=>[...r<0?[,-u,a]:[],e,,1,n,,t,r,,t,o],Ce=(e,...n)=>E(e,se(...n)),Oe=e=>{let[n,r]=W(e,1);return r.at(-1)+n.at(-1)};var ae=Math.PI,$=2*ae,ie=(e,n,r)=>Math.max(Math.min(e,r),n),O=Math.sin,G=Math.cos,v=Math.sign,D=Math.abs,H=e=>ie(Math.tan(e),-1,1),K=e=>1-(2*e/$%2+2)%2,Q=e=>1-4*Math.abs(Math.round(e/$)-e/$),X=e=>O(e**3),Y=e=>O(e**5);var Re=(e,n)=>()=>n,ue=()=>(e,...n)=>n.reduce((r,t)=>r+t,0),Z=()=>(e,...n)=>n.reduce((r,t)=>r*t,1),ce=e=>{var n=0;return(r,t,o,u=1,a=0,s=0)=>{let c=(o>3?X:o>2?H:o>1?K:o?Q:O)(s*$+(n+=t*$/e*(1+a*Y(r))));return v(c)*D(c)**u}},me=(e,n=2)=>{var r=0,t=0,o=0,u=0;return(a,s,c)=>{var l=$*D(s)*2/e,m=G(l),i=O(l)/2/n,p=1+i,f=-2*m/p,b=(1-i)/p,y=(1+v(s)*m)/2/p,d=-(v(s)+m)/p,M=y;return u=M*r+d*(r=t)+y*(t=c)-b*o-f*(o=u)}},pe=()=>{var e=0,n=0;return(r,t=0,o)=>(++e>=t&&(e=0,n=o),n)},le=(e,n)=>{if(n===0)return(u,a)=>a;let r=e*n|0,t=new Array(r).fill(0);var o=0;return(u,a,s=0)=>{let c=t[o];return t[o]=a+c*s,o=(o+1)%r,c}},de=e=>{var n=0,r=0;return(t,o,u=.05)=>(n!==o&&(r=o+(Math.random()-.5)*u*o,n=o),r)},ve={gain:Z,ringmod:Z,add:ue,wave:ce,filter:me,bitcrush:pe,delay:le,shimmer:de};function we(e){return e=e.replace(/([,\[\{}])([=>.]?[a-z_]+?)([,:\]\}])/ig,'$1"$2"$3').replace(/([,\[])!0([,\]])/g,"$1true$2").replace(/([,\[])!1([,\]])/g,"$1false$2").replace(/\[,/g,"[null,").replace(/,,\]/g,",null]").replace(/,\s*(?=[,\]])/g,",null").replace(/([\[,]-?)(?=\.)/g,"$10").replace(/-\./g,"-0."),console.log("preprocessed JSON string:",e),JSON.parse(e,(n,r)=>r===null?void 0:r)}function Ue(e){return JSON.stringify(e).replace(/true/g,"!0").replace(/false/g,"!1").replace(/,null\]/g,",,]").replace(/\[null,/g,"[,").replace(/,null(?=[,\]])/g,",").replace(/([\[,]-?)0(?=\.)/g,"$1").replace(/-0\./g,"-.").replace(/([,\[\{])"([=>.]?[a-z_]+?)"([,:\}])/ig,"$1$2$3")}var Pe=(e,n,r,t=44100)=>{let o=[],[u,a]=e,s={},c=a.map(([y,d])=>y(t,...d)),l=r*t,m=S(n,y=>E(t,y)),i=[];var p={},f,b;for(b=0;b<l;b++){p={};for(f of Object.keys(m))p[f]=m[f](b,p);for(i.length=0,f=0;f<u.length;f++){let d=u[f];if(T(d))s[d.slice(1)]=i.at(-1);else if(I(d))i.push(s[d.slice(1)]??0);else if(C(d))i.push(p[d.slice(1)]??0);else if(d.length===1)i.push(d[0]);else{let[M,V]=d;i.push(c[M](b,...i.splice(i.length-V,V)))}}let y=i.pop();if(!x(y))throw new Error(`got NaN sample at sampleNo=${b}`);o.push(y)}return o},ke=(e,n,r=44100)=>{let t=x(e[0])?[e]:e,o=n.createBuffer(t.length,t[0].length,r),u=n.createBufferSource();return t.map((a,s)=>o.getChannelData(s).set(a)),u.buffer=o,u};export{Ce as adsrNode,me as biquadFilter,pe as bitcrusher,Pe as buildSamples,$e as builtinMacros,ve as builtinNodes,Oe as channelDuration,te as combFilter,ge as compileInstrument,Re as constant,ye as debugDumpInstrument,le as delay,Z as gainMixer,k as macroexpand,se as makeADSRChannel,we as minparse,Ue as minstringify,de as shimmerer,E as standardChannel,ue as summingMixer,ke as toBufferNode,re as unisons,ce as zzfxOscillator};
//# sourceMappingURL=tinya.js.map
