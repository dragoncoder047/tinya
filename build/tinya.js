var _=(e,r)=>Object.fromEntries(Object.entries(e).map(([n,t])=>[n,r(t,n)])),oe=e=>typeof e,A=(e,r=oe)=>n=>r(n)===e,b=A("number"),E=A("undefined"),N=A("string"),R=e=>e===null,w=e=>e.length===0,M=e=>Object.is(e,-0),Z=e=>e>0||e===0&&!M(e),h=(e,...r)=>r.some(n=>n(e)),x=Array.isArray,z=A("object"),B=e=>h(e,R,E,b)||N(e)&&!(O(e)||T(e)||$(e)),U=e=>h(e,N,b,E,R)?!1:x(e)&&N(e[0])?J(e)?U(P(e)):!0:x(e[0])&&!w(e[0])&&N(e[0][0]),j=e=>r=>N(r)&&r.startsWith(e),O=j("."),T=j("="),$=j(">"),J=e=>x(e)&&T(e[0]),G=e=>J(e)?e[0]:void 0,P=e=>J(e)?e.slice(1):e,v={},q=e=>(v[e]=(v[e]||0)+1,`${e}${v[e]}`);var Te=(e,r)=>{let n=[],t=[],o=u=>{let a=G(u),s=P(u);for(var c=1;c<s.length;c++){let p=s[c];U(p)?o(p):h(p,T,$,O)?n.push(p):B(p)&&n.push([p])}n.push([t.length,s.length-1]);let[l,m]=x(s[0])&&!w(s[0])?[s[0][0],s[0].slice(1)]:[s[0],[]],i=N(l)&&r[l]||(()=>{throw new Error("undefined node type "+l)});t.push([i,m]),a!==void 0&&n.push(a)};return o(e),[n,t]},se="|   ",Ie=(e,r)=>{let[n,t]=e,o=m=>{for(var i of Object.keys(r))if(r[i]===m)return i;return m.name||"unknown"},u=t.map(([m,i],p)=>`call ${o(m)}(${i.join(", ")}) [index ${p}]`),a=[];var s=n.length-1;let c=(m,i)=>{a.push(`${se.repeat(m)}${i}`)},l=m=>{if(s<0)return;let i=n[s--];if(x(i))if(i.length===1)c(m,`push constant ${String(i[0])}`);else{let[f,g]=i;c(m,`${u[f]} with ${g}`);for(var p=0;p<g;p++)l(m+1)}else N(i)&&(O(i)?c(m,`push register ${i.slice(1)}`):$(i)?c(m,`push input channel ${i.slice(1)}`):T(i)&&(c(m,`store register ${i.slice(1)}`),l(m)))};return l(0),a.join(`
`)+`

`};var k=(e,r)=>{var n;return h(e,N,b,E,R)?e:x(e)?N(e[0])&&e[0]in r?h(n=r[e[0]](...e.slice(1)),x,z)?k(n,r):n:e.map(t=>k(t,r)):_(e,t=>k(t,r))};var ae=(e,r=1,n=0,t=0,o=1,u=1/r,a=1)=>{let s=["add"],c=e[a];for(var l=1;l<=r;l++){let m=t+n*(2*(l-1)/(r-1||1)-.5),i=Math.pow(2,m/12);s[l]=e.with(a,b(c)?c*i:["gain",c,i]),l>1&&o!==1&&(s[l]=["gain",o,s[l]])}return u!==1?["gain",u,s]:s},ie=(e,r,n=.9,t=!1)=>{let o=q("=combfilter_feed_"),u=t?[]:[o],a=t?[o]:[];return[...u,"add",[...a,"add",e],["gain",n,[["delay",r],"."+o.slice(1)]]]},_e={unison:ae,combfilter:ie};var ue=(e,r=1,n,t,o)=>o>0?r<0?t+(n-t)*((o-e)/o)**-r:n+(t-n)*(e/o)**r:t,W=(e,r)=>{let n=[],t=[],o=[],u=[];for(var a=0,s=0;s<e.length;s+=3){let c=(e[s]??0)*r;n.push(c),t.push(a),o.push(e[s+1]??1),u.push(e[s+2]??0),a+=c}return[n,t,o,u]},V=(e,r)=>{let[n,t,o,u]=W(r,e);var a=0;return s=>{if(s>=t.at(-1)+n.at(-1))return 0;for(;s<t[a];)a--;for(;s>t[a]+n[a];)a++;return ue(s-t[a],o[a],u[a-1]??0,u[a],n[a])}},ce=(e=0,r=0,n=0,t=1,o=.1,u=0,a=5)=>[...n<0?[,-u,a]:[],e,,1,r,,t,n,,t,o],Ee=(e,...r)=>V(e,ce(...r)),Re=e=>{let[r,n]=W(e,1);return n.at(-1)+r.at(-1)};var me=Math.PI,I=2*me,pe=(e,r,n)=>Math.max(Math.min(e,n),r),C=Math.sin,X=Math.cos,F=Math.sign,D=Math.abs,H=e=>pe(Math.tan(e),-1,1),K=e=>1-(2*e/I%2+2)%2,Q=e=>1-4*Math.abs(Math.round(e/I)-e/I),Y=e=>C(e**3),ee=e=>C(e**5);var Me=(e,r)=>()=>r,le=()=>(e,...r)=>r.reduce((n,t)=>n+t,0),ne=()=>(e,...r)=>r.reduce((n,t)=>n*t,1),de=e=>{var r=0;return(n,t,o,u=1,a=0,s=0)=>{let c=(o>3?Y:o>2?H:o>1?K:o?Q:C)(s*I+(r+=t*I/e*(1+a*ee(n))));return F(c)*D(c)**u}},fe=(e,r=2)=>{var n=0,t=0,o=0,u=0;return(a,s,c)=>{var l=I*D(s)*2/e,m=X(l),i=C(l)/2/r,p=1+i,f=-2*m/p,g=(1-i)/p,y=(1+F(s)*m)/2/p,d=-(F(s)+m)/p,S=y;return u=S*n+d*(n=t)+y*(t=c)-g*o-f*(o=u)}},ge=()=>{var e=0,r=0;return(n,t=0,o)=>(++e>=t&&(e=0,r=o),r)},Ne=(e,r)=>{if(r===0)return(u,a)=>a;let n=e*r|0,t=new Array(n).fill(0);var o=0;return(u,a,s=0)=>{let c=t[o];return t[o]=a+c*s,o=(o+1)%n,c}},be=e=>{var r=0,n=0;return(t,o,u=.05)=>(r!==o&&(n=o+(Math.random()-.5)*u*o,r=o),n)},Ue={gain:ne,ringmod:ne,add:le,wave:de,filter:fe,bitcrush:ge,delay:Ne,shimmer:be};function Pe(e){return e=e.replace(/([,\[\{}])([=>.]?[a-z_]+?)([,:\]\}])/ig,'$1"$2"$3').replace(/([,\[])!0([,\]])/g,"$1true$2").replace(/([,\[])!1([,\]])/g,"$1false$2").replace(/\[,/g,"[null,").replace(/,,\]/g,",null]").replace(/,\s*(?=[,\]])/g,",null").replace(/([\[,]-?)(?=\.)/g,"$10").replace(/-\./g,"-0."),console.log("preprocessed JSON string:",e),JSON.parse(e,(r,n)=>n===null?void 0:n)}var re="____NZ",te=JSON.stringify,ye=new RegExp(te(re),"g");function ke(e){return te(e,(r,n)=>b(n)&&M(n)?re:n).replace(/true/g,"!0").replace(/false/g,"!1").replace(/,null\]/g,",,]").replace(/\[null,/g,"[,").replace(/,null(?=[,\]])/g,",").replace(/([\[,]-?)0(?=\.)/g,"$1").replace(/-0\./g,"-.").replace(ye,"-0").replace(/([,\[\{])"([=>.]?[a-z_]+?)"([,:\}])/ig,"$1$2$3")}var Ze=(e,r,n,t=44100)=>{let o=[],[u,a]=e,s={},c=a.map(([y,d])=>y(t,...d)),l=n*t,m=_(r,y=>V(t,y)),i=[];var p={},f,g;for(g=0;g<l;g++){p={};for(f of Object.keys(m))p[f]=m[f](g,p);for(i.length=0,f=0;f<u.length;f++){let d=u[f];if(T(d))s[d.slice(1)]=i.at(-1);else if(O(d))i.push(s[d.slice(1)]??0);else if($(d))i.push(p[d.slice(1)]??0);else if(d.length===1)i.push(d[0]);else{let[S,L]=d;Z(S)?i.push(c[S](g,...i.splice(i.length-L,L))):i.push(p[-S]??0)}}let y=i.pop();if(!b(y))throw new Error(`got NaN sample at sampleNo=${g}`);o.push(y)}return o},ze=(e,r,n=44100)=>{let t=b(e[0])?[e]:e,o=r.createBuffer(t.length,t[0].length,n),u=r.createBufferSource();return t.map((a,s)=>o.getChannelData(s).set(a)),u.buffer=o,u};export{Ee as adsrNode,fe as biquadFilter,ge as bitcrusher,Ze as buildSamples,_e as builtinMacros,Ue as builtinNodes,Re as channelDuration,ie as combFilter,Te as compileInstrument,Me as constant,Ie as debugDumpInstrument,Ne as delay,ne as gainMixer,k as macroexpand,ce as makeADSRChannel,Pe as minparse,ke as minstringify,be as shimmerer,V as standardChannel,le as summingMixer,ze as toBufferNode,ae as unisons,de as zzfxOscillator};
//# sourceMappingURL=tinya.js.map
