import{a as w}from"./chunk-UPE2MW7Z.js";import{a as l,l as I,m as F,v as D}from"./chunk-P5FSJCFO.js";var A=class{constructor(e,t){this.mode=t;this.value=e}static{l(this,"AutomatedValue")}delta=0;value=0;target=0;timeLeft=0;goto(e,t,s){switch(this.mode){case 0:this.delta=t*(e-this.value)/s;break;case 1:if(this.value*e<=0)throw new Error("cannot cross 0 when in exponential mode");this.delta=Math.pow(e/this.value,t/s)}this.target=e,this.timeLeft=s}update(e){if(this.timeLeft-=e,this.timeLeft<0)return this.timeLeft=0,this.value=this.target;switch(this.mode){case 0:return this.value+=this.delta;case 1:return this.value*=this.delta}}};var E=class{constructor(e,t,s,r,c){this.dt=t;this.synth=s;this.p=e.p,this.r=e.r.map(o=>0),this.n=e.nn.map(o=>s.nodes.find(h=>h[0]===o)[4](s)),this.pitch=new A(r,1),this.expression=new A(c,1),this.mods=e.mods.map(([o,h,i])=>new A(h,i)),this.modToIndexMap=Object.fromEntries(e.mods.map((o,h)=>[o[0],h])),e.tosStereo&&this.p.push(15)}static{l(this,"Tone")}p;r;n;sc=[];ac=[];acL=[];acR=[];tmp=null;pitch;expression;mods;modToIndexMap;alive=!0;processSample(e,t,s,r,c,o){let h=this.sc,i=this.sc,p=this.acL,b=this.acR,v=this.p,x=this.r,k=this.n,g=this.tmp,B=this.pitch.value,M=this.expression.value,m=l(S=>h[O++]=S,"push"),a=l(()=>h[O--],"pop"),L=l(()=>h[O],"peek"),d=l(()=>v[R++],"next");var R,O,n,T,f,u;for(h.length=i.length=p.length=b.length=R=O=0;R<v.length;){let S=d();switch(S){case 0:m(d());break;case 1:g.length=2,g[0]=t[e],g[1]=s[e],m(g);break;case 2:m(B);break;case 3:m(M);break;case 4:m(c);break;case 5:this.alive=!0;break;case 6:a();break;case 7:m([]);break;case 8:n=a(),L().push(n);break;case 9:n=a(),L().push(...n);break;case 10:T=a(),n=a(),m(D[d()].cb(n,T));break;case 11:n=a(),m(D[d()].cu(n));break;case 12:m(x[d()]);break;case 13:x[d()]=L();break;case 14:f=a(),T=a(),n=a(),m(f?T:n);break;case 15:n=a(),m([n,n]);break;case 16:for(n=a(),f=a(),i.length=f,u=0;u<f;)i[u++]=a();m(k[n](this.dt,i));break;case 18:m(this.mods[d()]?.value??0);break;case 17:for(n=a(),T=a(),f=a(),p.length=b.length=f,u=0;u<f;)i[u++]=a();for(u=0;u<f;)F(i[u])?(p[u]=i[u][0],b[u]=i[u][1]):p[u]=b[u]=i[u],u++;m([k[n](this.dt,p),k[T](this.dt,b)]);break;default:}}switch(n=a(),I(n[0])&&isNaN(n[0])&&(n[0]=0),I(n[0])&&isNaN(n[1])&&(n[1]=0),r){case 0:t[e]=n[0]*o,s[e]=n[1]*o;break;case 1:t[e]+=n[0]*o,s[e]+=n[1]*o;break}}processBlock(e,t,s,r,c){let o=e.length;var h,i;for(h=0;h<o;h++){for(i=0;i<this.mods.length;i++)this.mods[i].update(this.dt);this.processSample(h,e,t,s,r,c)}}automate(e,t,s){this.mods[this.modToIndexMap[e]]?.goto(t,this.dt,s)}};var _=class{constructor(e,t,s,r){this.dt=e;this.synth=t;this.voiceTemplate=s;this.fx=new E(r,e,t,1,1)}static{l(this,"Instrument")}liveNotes={};liveNoteCount=0;deadNotes={};fx;inputs={};prevInputs=null;lb=new Float32Array;rb=new Float32Array;noteOn(e,t,s){this.liveNotes[e]&&this.noteOff(e),this.liveNotes[e]=new E(this.voiceTemplate,this.dt,this.synth,t,s),this.liveNoteCount++}noteOff(e){let t=this.liveNotes[e];t&&(this.deadNotes[e]=[t,C(this.liveNoteCount)],delete this.liveNotes[e],this.liveNoteCount--)}pitchBend(e,t,s){this.liveNotes[e]?.pitch.goto(t,this.dt,s)}expressionBend(e,t,s){this.liveNotes[e]?.expression.goto(t,this.dt,s)}automate(e,t,s,r){if(r!==void 0)this.liveNotes[r].automate(e,t,s);else{for(var c of Object.keys(this.liveNotes))this.liveNotes[+c].automate(e,t,s);this.fx.automate(t,this.dt,s)}}process(e,t){var s=this.lb,r=this.rb,c=e.length;s.buffer.byteLength<e.buffer.byteLength?(this.lb=s=new Float32Array(c),this.rb=r=new Float32Array(c)):s.length!==c&&(this.lb=s=new Float32Array(s.buffer,0,c),this.rb=r=new Float32Array(r.buffer,0,c));var o;let h=this.liveNoteCount,i=this.liveNotes,p=this.deadNotes;for(o in i)i[o].processBlock(s,r,1,!0,C(h));for(o in p){var b=p[o][0],v=p[o][1];b.alive=!1,b.processBlock(s,r,1,!1,v),b.alive||delete p[o]}for(this.fx.processBlock(s,r,0,!0,1),o=0;o<c;o++)e[o]+=s[o],t[o]+=r[o]}};function C(N){return 1/((N-1)/4+1)}l(C,"gainForChord");var y=class{constructor(e,t,s,r){this.dt=e;this.nodes=t;for(var[c,o]of s)this.instruments.push(new _(e,this,c,o));this.postFX=new E(r,e,this,1,.3)}static{l(this,"Synth")}instruments=[];postFX;n2i={};waves={};addWave(e,t){this.waves[e]=t}_ifn(e){return this.instruments[this.n2i[e]]}noteOn(e,t,s,r){this._ifn(e)?.noteOff(e),this.instruments[this.n2i[e]=t]?.noteOn(e,s,r)}noteOff(e){this._ifn(e)?.noteOff(e),delete this.n2i[e]}automate(e,t,s,r){(this.instruments[e]??this.postFX).automate(t,s,r)}pitchBend(e,t,s){this._ifn(e)?.pitchBend(e,t,s)}expressionBend(e,t,s){this._ifn(e)?.expressionBend(e,t,s)}process(e,t){let s=this.instruments;for(var r=0;r<s.length;r++)s[r].process(e,t)}};var P=class extends AudioWorkletProcessor{static{l(this,"SydWorklet")}s=null;dt;constructor(e){super(),this.dt=1/(e??globalThis.sampleRate),this.port.addEventListener("message",t=>this.processMessage(t.data))}processMessage(e){switch(e[0]){case 0:this.s=new y(this.dt,w(),e[1],e[2]);return}let t=this.s;switch(e[0]){case 1:t.addWave(e[1],e[2]);break;case 2:t.noteOn(e[1],e[2],e[3],e[4]);break;case 3:t.noteOff(e[1]);break;case 6:t.automate(e[1],e[2],e[3],e[4]);break;case 4:e[1]?t.pitchBend(e[2],e[3],e[4]):t.postFX.pitch.goto(e[2],e[3],e[4]);break;case 5:e[1]?t.expressionBend(e[2],e[3],e[4]):t.postFX.expression.goto(e[2],e[3],e[4]);break;default:e[0]}}process(e,t){return t.length>0&&this.s.process(t[0][0],t[0][1]),!0}};registerProcessor("syd",P);
//# sourceMappingURL=sydWorklet.js.map
